# Architecture and design

The architecture is shown in the picture below.

![Architecture Diagram](architecture.svg)

The components in this picture are as follows.

- The master copy of all data is stored in the Safety Culture platform, which is the platform used for all inspections.

- An Azure resource group holds all of the tooling. All of this is deployed using a BICEP template.

    - An Azure SQL Server database contains tables which match the data in Safety Culture and Views created of that data.

    - The tables and views are created and maintained by an Azure Container App Job, which logs to a local instance of Log Analytics.

    - The container image for the job is stored in a Container Registry.

    - As far as possible, all resources use Entra Authentication and managed identities to avoid any need for them to use passwords or secrets. The exceptions are that there is an access token for Safety Culture and a SQL database admin password; both of these are stored in an Azure Key Vault. The SQL Server database password is randomly generated automatically at deploy time, and can be regenerated by redeploying the BICEP template.

The data flows through the system as follows.

- Every night the Azure Container App Job runs the Safety Culture exporter to update the database with the latest data. The job maintains a record of when it was last successfully run so as to only perform incremental updates.

- Since the Safety Culture data format does not map well to what we wish to display, the data is mapped into a number of views. These are created and updated as required by the same job.

- Users access the data using Power BI, deployed either in the Power BI Service or on the desktop. Power BI is configured to read the data on demand from the views stored in the SQL database. Authentication for this interface occurs using Entra ID (i.e. users must log in with their organisational accounts, which have been granted read rights to the database).

